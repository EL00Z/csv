<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CSV Data Cleaner - Smart Filtering Tool</title>
    <style>
        :root{
            --accent1: #667eea;
            --accent2: #764ba2;
            --muted: #6b7280;
            --bg: #f7fafc;
            --card: #ffffff;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto, "Helvetica Neue", Arial;
            background: linear-gradient(135deg,#f0f4ff 0%, #fef7ff 100%);
            padding:24px;
            color:#111827;
        }
        .container{
            max-width:1200px;
            margin:0 auto;
            border-radius:12px;
            background:var(--card);
            box-shadow: 0 8px 30px rgba(15,23,42,0.08);
            overflow:hidden;
        }
        .header{
            padding:28px 30px;
            background:linear-gradient(135deg,var(--accent1) 0%, var(--accent2) 100%);
            color:#fff;
        }
        .header h1{font-size:20px;margin-bottom:6px;font-weight:700}
        .header p{opacity:0.92;font-size:13px}
        .main{padding:24px;display:grid;grid-template-columns:1fr 380px;gap:20px}
        @media(max-width:980px){ .main{grid-template-columns:1fr} }

        /* LEFT column blocks */
        .block{background:var(--bg);border-radius:10px;padding:16px;box-shadow:0 3px 12px rgba(2,6,23,0.03)}
        .file-area{display:flex;flex-direction:column;align-items:flex-start;gap:12px}
        .file-input-label{
            display:inline-flex;align-items:center;gap:10px;
            padding:10px 16px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));
            color:white;font-weight:600;cursor:pointer;border:none;
        }
        .file-info{font-size:13px;color:var(--muted);padding:10px 12px;border-radius:8px;background:#fff}
        .col-select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ef;font-size:14px}

        .filter-grid{display:flex;gap:16px;margin-top:14px}
        .filter-card{flex:1;padding:14px;border-radius:10px;background:white;border:1px solid #eef2ff}
        .filter-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .toggle-switch{position:relative;width:50px;height:28px}
        .toggle-switch input{display:none}
        .toggle-slider{position:absolute;inset:0;background:#e6e7ee;border-radius:999px;cursor:pointer;transition:.24s}
        .toggle-slider:before{content:"";position:absolute;width:20px;height:20px;border-radius:50%;background:#fff;left:4px;bottom:4px;transition:.24s}
        .toggle-switch input:checked + .toggle-slider{background:linear-gradient(90deg,var(--accent1),var(--accent2))}
        .toggle-switch input:checked + .toggle-slider:before{transform:translateX(22px)}

        .keywords-list{min-height:56px;padding:8px;border-radius:8px;background:#fbfbfe;border:1px solid #f0f3ff;display:flex;flex-wrap:wrap;gap:8px}
        .tag{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;font-size:13px}
        .tag.ex{background:linear-gradient(90deg,#f093fb,#f5576c)}
        .tag .remove{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:rgba(255,255,255,0.18);cursor:pointer;font-weight:700}
        .add-area{display:flex;gap:8px;margin-top:10px}
        .custom-input{flex:1;padding:8px;border-radius:8px;border:1px solid #e6e9ef;font-size:13px}
        .btn{padding:9px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
        .btn.add{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white}
        .btn.process{background:#0ea5a4;color:white;margin-top:12px;width:100%;font-size:15px;padding:12px;border-radius:10px}

        /* RIGHT column */
        .right{display:flex;flex-direction:column;gap:12px}
        .stats{display:flex;gap:8px;justify-content:space-between;align-items:center}
        .stat{background:white;padding:12px;border-radius:8px;flex:1;border:1px solid #f0f3ff;text-align:center}
        .stat .num{font-weight:700;color:var(--accent1);font-size:18px}
        .preview{margin-top:6px;background:white;border-radius:10px;padding:12px;border:1px solid #eef2ff;overflow:auto}
        table{width:100%;border-collapse:collapse;font-size:13px}
        th{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:white;text-align:left;padding:8px;font-weight:700}
        td{padding:8px;border-bottom:1px solid #f5f7ff}
        .muted{color:var(--muted);font-size:13px}
        .controls{display:flex;gap:8px;align-items:center}
        .download{background:linear-gradient(90deg,#30cfd0,#330867);color:white;padding:8px 12px;border-radius:8px;border:none;font-weight:700}
        .small{font-size:12px;color:var(--muted)}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CSV Data Cleaner</h1>
            <p>Smart filter for cleaning and organizing CSVs ‚Äî robust parsing, interactive keywords.</p>
        </div>

        <div class="main">
            <!-- LEFT -->
            <div>
                <div class="block file-area">
                    <label class="file-input-label" for="csvFile">üìÅ Choose CSV File (Max 50MB)</label>
                    <input id="csvFile" type="file" accept=".csv" style="display:none" />
                    <div id="fileInfo" class="file-info" style="display:none">
                        <div><strong>File:</strong> <span id="fileName"></span></div>
                        <div class="small"><strong>Size:</strong> <span id="fileSize"></span> ‚Ä¢ <strong>Rows:</strong> <span id="rowCount"></span> ‚Ä¢ <strong>Columns:</strong> <span id="columnCount"></span></div>
                    </div>
                </div>

                <div class="block" id="colBlock" style="margin-top:16px;display:none">
                    <label class="small" style="display:block;margin-bottom:8px">Select column to filter</label>
                    <select id="columnSelect" class="col-select"></select>
                </div>

                <div class="filter-grid">
                    <div class="filter-card">
                        <div class="filter-head">
                            <div style="display:flex;flex-direction:column">
                                <strong>‚úÖ Inclusion Keywords</strong>
                                <span class="small">Rows must include one of these (when enabled)</span>
                            </div>
                            <label class="toggle-switch">
                                <input id="inclusionToggle" type="checkbox" checked />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div id="inclusionKeywords" class="keywords-list" aria-live="polite"></div>

                        <div class="add-area">
                            <input id="customInclusion" class="custom-input" placeholder="Add custom keywords (comma separated)" />
                            <button id="addInclusion" class="btn add">Add</button>
                        </div>
                    </div>

                    <div class="filter-card">
                        <div class="filter-head">
                            <div style="display:flex;flex-direction:column">
                                <strong>‚ùå Exclusion Keywords</strong>
                                <span class="small">Rows containing any of these will be removed (when enabled)</span>
                            </div>
                            <label class="toggle-switch">
                                <input id="exclusionToggle" type="checkbox" checked />
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div id="exclusionKeywords" class="keywords-list" aria-live="polite"></div>

                        <div class="add-area">
                            <input id="customExclusion" class="custom-input" placeholder="Add custom keywords (comma separated)" />
                            <button id="addExclusion" class="btn add">Add</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top:14px">
                    <button id="processBtn" class="btn process" disabled>üöÄ Process & Filter</button>
                </div>
            </div>

            <!-- RIGHT -->
            <div class="right">
                <div class="block stats">
                    <div class="stat">
                        <div class="small">Original Rows</div>
                        <div class="num" id="originalRows">0</div>
                    </div>
                    <div class="stat">
                        <div class="small">Filtered Rows</div>
                        <div class="num" id="filteredRows">0</div>
                    </div>
                    <div class="stat">
                        <div class="small">Removed</div>
                        <div class="num" id="removedRows">0</div>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px">
                        <div class="small">Data Retained</div>
                        <div class="num" id="percentageKept">0%</div>
                    </div>
                </div>

                <div class="block preview">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                        <div><strong>Preview (first 10 rows)</strong></div>
                        <div class="controls">
                            <button id="downloadBtn" class="download" style="display:none">‚¨áÔ∏è Download Cleaned CSV</button>
                        </div>
                    </div>
                    <div id="previewTableWrap" style="max-height:380px;overflow:auto">
                        <table id="previewTable"><tbody></tbody></table>
                    </div>
                </div>

                <div style="font-size:12px;color:var(--muted);padding:8px 12px">Tip: Click any keyword tag to remove it. Use the Add buttons to add new keywords. Toggles enable/disable filters independently.</div>
            </div>
        </div>
    </div>

<script>
/* -------------------------
   Default keywords (lowercased)
   ------------------------- */
const defaultInclusionKeywords = [
    'architect','asset management','blockchain','capital markets','cbdc','ceo','chief','chief digital officer',
    'chief innovation officer','chief strategy officer','cio','ciso','co-founder','coo','cpo','crypto','cto',
    'custody','data intelligence','defi','developer','digital asset','digital banking','digital currency',
    'digital transformation lead','director','director of digital assets','director of engineering','engineer',
    'executive','fintech','founder','general manager','global head of digital assets','growth lead','head',
    'head of blockchain and digital assets','head of defi','head of digital','head of digital assets','head of ecosystem',
    'head of engineering','head of enterprise architecture','head of global payments','head of growth','head of innovation',
    'head of it','head of payments','head of product','head of product innovation','head of retail payments','head of rwa',
    'head of stablecoins','head of strategy','head of strategy and innovation','head of tokenization','innovation','lead',
    'llm','manager','managing','managing director','managing partner','mena','open banking','partner','payment','payments',
    'platform','president','principal','product','product head','product strategy','rwa','senior','specialist','stablecoin',
    'strategy','tokenization','transformation','vp','vp of engineering','vp of it','vp of product'
].map(k => k.toLowerCase());

const defaultExclusionKeywords = [
    'account executive','accountant','academic','actor','administrative assistant','agriculture','airdrop','ambassador',
    'angel','angel investor','analyst','artist','assistant','attorney','audit','auditor','back-end developer','bdr',
    'business analyst','business development','business development representative','channel','chief of staff','community',
    'community manager','construction','content','content creator','controller','cpa','customer','customer service representative',
    'cyber security','data entry','data scientist','degen','devops engineer','doctor','editor','educator','energy','entertainment',
    'entry-level','epamsystems','event manager','executive assistant','factory','farmer','film','finance manager','financial models',
    'former','freight','front-end developer','gamer','gas','general counsel','giveaway','graphic designer','hardware','hardware engineer',
    'hospitality','hr','hr manager','human resources','industrial','influencer','intern','inventory','investor relations','junior','journalist',
    'kol','lawyer','lecturer','legal','legal counsel','logistics','manufacturing','marketer','marketing','marketing manager','marketing specialist',
    'materials','mechanical engineer','media','memes','memecoin','mining','moderator','music','musician','non-profit','nurse','office manager',
    'oil','operations manager','paralegal','petroleum','physical','physician','plant manager','podcast','pr','prediction','private banker','producer',
    'professor','program','project management','promoter','procurement','public relations','qa','quality assurance','real estate','recruiter',
    'recruitment consultant','researcher','risk','sales','sales consultant','sales representative','scientist','shill','shiller','shipping',
    'singer','smm','social media','social media manager','software engineer','software test engineer','streamer','supply chain','support agent',
    'sustainability','tax','teacher','team head','technical lead','technician','telecom','talent acquisition','trenches','transportation','user',
    'ux researcher','venture partner','warehouse','web developer','writer','yapper','copywriter'
].map(k => k.toLowerCase());

/* Requested additions (ensure present) */
const ensureExclusions = ['ux design','ui/ux','design ux','design ui','art director','treasury','creative director'];
const ensureInclusions = ['ecosystem growth','defi','ecosystem','virtual assets'];

/* working arrays (mutable) */
let inclusionKeywordsArr = Array.from(new Set([...defaultInclusionKeywords, ...ensureInclusions.map(k=>k.toLowerCase())]));
let exclusionKeywordsArr = Array.from(new Set([...defaultExclusionKeywords, ...ensureExclusions.map(k=>k.toLowerCase())]));

/* CSV data holders */
let csvData = []; // array of objects
let headers = []; // array of header names
let processedData = [];

/* DOM refs */
const inclusionContainer = document.getElementById('inclusionKeywords');
const exclusionContainer = document.getElementById('exclusionKeywords');
const inclusionToggle = document.getElementById('inclusionToggle');
const exclusionToggle = document.getElementById('exclusionToggle');
const customInclusion = document.getElementById('customInclusion');
const customExclusion = document.getElementById('customExclusion');
const addInclusionBtn = document.getElementById('addInclusion');
const addExclusionBtn = document.getElementById('addExclusion');
const processBtn = document.getElementById('processBtn');
const downloadBtn = document.getElementById('downloadBtn');
const previewTable = document.getElementById('previewTable');

/* Render keywords tags */
function renderKeywords() {
    inclusionContainer.innerHTML = inclusionKeywordsArr.map(k => {
        const safe = escapeHtml(k);
        return `<span class="tag" data-type="inclusion" data-key="${safe}">${safe}<span class="remove" title="Remove">&times;</span></span>`;
    }).join('') || '<span class="small muted">No inclusion keywords</span>';

    exclusionContainer.innerHTML = exclusionKeywordsArr.map(k => {
        const safe = escapeHtml(k);
        return `<span class="tag ex" data-type="exclusion" data-key="${safe}">${safe}<span class="remove" title="Remove">&times;</span></span>`;
    }).join('') || '<span class="small muted">No exclusion keywords</span>';
}

/* Helper: escape for attributes/display */
function escapeHtml(str){
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

/* Click-to-remove using event delegation */
inclusionContainer.addEventListener('click', function(e){
    const tag = e.target.closest('.tag');
    if(!tag) return;
    if(e.target.classList.contains('remove')){
        const key = tag.getAttribute('data-key');
        inclusionKeywordsArr = inclusionKeywordsArr.filter(k => k !== key);
        renderKeywords();
    }
});
exclusionContainer.addEventListener('click', function(e){
    const tag = e.target.closest('.tag');
    if(!tag) return;
    if(e.target.classList.contains('remove')){
        const key = tag.getAttribute('data-key');
        exclusionKeywordsArr = exclusionKeywordsArr.filter(k => k !== key);
        renderKeywords();
    }
});

/* Add keywords from input */
function addKeywordsFromInput(type){
    const input = type === 'inclusion' ? customInclusion : customExclusion;
    const raw = input.value || '';
    const parts = raw.split(',').map(s => s.trim().toLowerCase()).filter(Boolean);
    if(parts.length === 0) return;
    if(type === 'inclusion'){
        inclusionKeywordsArr = Array.from(new Set([...inclusionKeywordsArr, ...parts]));
    } else {
        exclusionKeywordsArr = Array.from(new Set([...exclusionKeywordsArr, ...parts]));
    }
    input.value = '';
    renderKeywords();
}
addInclusionBtn.addEventListener('click',()=>addKeywordsFromInput('inclusion'));
addExclusionBtn.addEventListener('click',()=>addKeywordsFromInput('exclusion'));

/* Toggle changes: optional auto-reprocess - keep manual process for predictability */
inclusionToggle.addEventListener('change', ()=>{/* noop for now */});
exclusionToggle.addEventListener('change', ()=>{/* noop for now */});

/* -------------------------
   Robust CSV parser (handles quoted fields with commas & newlines)
   ------------------------- */
function parseCSV(text){
    // Normalize line endings
    // We'll iterate char-by-char to allow newlines inside quoted fields.
    const rows = [];
    let field = '';
    let row = [];
    let inQuotes = false;
    for(let i=0;i<text.length;i++){
        const ch = text[i];
        if(ch === '"'){
            // If inQuotes and next char is also quote => escaped quote
            if(inQuotes && text[i+1] === '"'){
                field += '"';
                i++; // skip next quote
            } else {
                inQuotes = !inQuotes;
            }
        } else if((ch === '\r' || ch === '\n') && !inQuotes){
            // End of record. Handle CRLF
            if(ch === '\r' && text[i+1] === '\n'){ i++; }
            row.push(field);
            rows.push(row);
            row = [];
            field = '';
        } else if(ch === ',' && !inQuotes){
            row.push(field);
            field = '';
        } else {
            field += ch;
        }
    }
    // push last
    row.push(field);
    rows.push(row);

    // Remove any trailing blank row(s) that have all empty strings
    while(rows.length && rows[rows.length-1].every(c => c === '' || c === null || (typeof c === 'string' && c.trim()===''))){
        rows.pop();
    }
    if(rows.length === 0) return { headers: [], data: [] };

    // Trim header cells
    const hdrs = rows[0].map(h => (h || '').trim());
    const dataRows = rows.slice(1).map(r => {
        const obj = {};
        for(let i=0;i<hdrs.length;i++){
            const v = r[i] !== undefined && r[i] !== null ? String(r[i]).trim() : '';
            obj[hdrs[i]] = v;
        }
        return obj;
    });

    return { headers: hdrs, data: dataRows };
}

/* Convert data -> CSV (proper quoting) */
function dataToCSV(headersArr, dataArr){
    const lines = [];
    const headerLine = headersArr.map(h => {
        if(String(h).includes(',') || String(h).includes('"') || String(h).includes('\n')) {
            return `"${String(h).replace(/"/g,'""')}"`;
        }
        return h;
    }).join(',');
    lines.push(headerLine);
    for(const row of dataArr){
        const vals = headersArr.map(h => {
            const v = row[h] !== undefined && row[h] !== null ? String(row[h]) : '';
            if(v.includes(',') || v.includes('"') || v.includes('\n')){
                return `"${v.replace(/"/g,'""')}"`;
            }
            return v;
        });
        lines.push(vals.join(','));
    }
    return lines.join('\n');
}

/* Keyword matching (both sides are lowercased) */
function matchesKeywords(text, keywords){
    if(!text) return false;
    const lower = String(text).toLowerCase();
    return keywords.some(k => {
        if(!k) return false;
        return lower.includes(k);
    });
}

/* Main filter logic */
function filterData(){
    const selectedColumn = document.getElementById('columnSelect').value;
    if(!selectedColumn){
        alert('Please select a column to filter');
        return;
    }
    const inclusionEnabled = inclusionToggle.checked;
    const exclusionEnabled = exclusionToggle.checked;

    // Ensure keyword lists are deduped and lowercased
    const incKeys = inclusionKeywordsArr.map(k => String(k).toLowerCase().trim()).filter(Boolean);
    const excKeys = exclusionKeywordsArr.map(k => String(k).toLowerCase().trim()).filter(Boolean);

    // Apply filter
    processedData = csvData.filter(row => {
        const val = row[selectedColumn] || '';

        // Exclusion first: if enabled and matches -> drop row
        if(exclusionEnabled && excKeys.length > 0 && matchesKeywords(val, excKeys)){
            return false;
        }

        // Inclusion: if enabled -> must match one of inclusion keywords
        if(inclusionEnabled && incKeys.length > 0){
            return matchesKeywords(val, incKeys);
        }

        // Otherwise (no inclusion enabled): keep row (unless excluded earlier)
        return true;
    });

    updateStats();
    showPreview();
}

/* Update stats panel */
function updateStats(){
    const original = csvData.length;
    const filtered = processedData.length;
    const removed = Math.max(0, original - filtered);
    const percent = original > 0 ? Math.round((filtered / original) * 100) : 0;

    document.getElementById('originalRows').textContent = original;
    document.getElementById('filteredRows').textContent = filtered;
    document.getElementById('removedRows').textContent = removed;
    document.getElementById('percentageKept').textContent = percent + '%';
}

/* Render preview (first 10 rows) */
function showPreview(){
    const table = document.getElementById('previewTable');
    table.innerHTML = '';
    const tbody = document.createElement('tbody');

    if(!processedData || processedData.length === 0){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.textContent = 'No data matches the filter criteria';
        td.style.padding = '12px';
        tr.appendChild(td);
        tbody.appendChild(tr);
        table.appendChild(tbody);
        return;
    }

    // header row
    const theadTr = document.createElement('tr');
    headers.forEach(h => {
        const th = document.createElement('th');
        th.textContent = h;
        theadTr.appendChild(th);
    });
    tbody.appendChild(theadTr);

    const preview = processedData.slice(0,10);
    preview.forEach(r => {
        const tr = document.createElement('tr');
        headers.forEach(h => {
            const td = document.createElement('td');
            td.textContent = r[h] || '';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });

    table.appendChild(tbody);
}

/* File input handling */
document.getElementById('csvFile').addEventListener('change', function(e){
    const file = e.target.files[0];
    if(!file) return;
    if(file.size > 50 * 1024 * 1024){
        alert('File size exceeds 50MB limit');
        e.target.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function(ev){
        const text = ev.target.result;
        const parsed = parseCSV(text);

        csvData = parsed.data;
        headers = parsed.headers;

        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = (file.size / 1024).toFixed(2) + ' KB';
        document.getElementById('rowCount').textContent = csvData.length;
        document.getElementById('columnCount').textContent = headers.length;
        document.getElementById('fileInfo').style.display = 'block';

        // populate column selector
        const colSelect = document.getElementById('columnSelect');
        colSelect.innerHTML = '<option value="">Select a column...</option>';
        headers.forEach(h => {
            const opt = document.createElement('option');
            opt.value = h;
            opt.textContent = h;
            if(h.toLowerCase().includes('job') || h.toLowerCase().includes('title')) opt.selected = true;
            colSelect.appendChild(opt);
        });

        document.getElementById('colBlock').style.display = 'block';
        processBtn.disabled = false;

        // clear previous preview/stats
        processedData = [];
        updateStats();
        document.getElementById('previewTable').innerHTML = '';
        downloadBtn.style.display = 'none';
    };
    reader.readAsText(file);
});

/* Process button */
processBtn.addEventListener('click', function(){
    try {
        filterData();
        downloadBtn.style.display = processedData && processedData.length ? 'inline-block' : 'none';
    } catch(err){
        console.error(err);
        alert('Error during processing: ' + String(err.message || err));
    }
});

/* Download cleaned CSV */
downloadBtn.addEventListener('click', function(){
    if(!processedData || !processedData.length){
        alert('No data to download');
        return;
    }
    const csv = dataToCSV(headers, processedData);
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cleaned_data.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
});

/* init */
function init(){
    renderKeywords();
}
init();
</script>
</body>
</html>
